# üß™ **Guide de Test Complet - Syst√®me de Gestion des Cong√©s**

## **üìã Table des Mati√®res**

1. [Pr√©paration de l'Environnement](#1-pr√©paration-de-lenvironnement)
2. [Test des Soldes de Cong√©s](#2-test-des-soldes-de-cong√©s)
3. [Test des R√®gles de Validation](#3-test-des-r√®gles-de-validation)
4. [Test du Workflow d'Approbation](#4-test-du-workflow-dapprobation)
5. [Test de Gestion des Absences](#5-test-de-gestion-des-absences)
6. [Test des APIs via Interface](#6-test-des-apis-via-interface)
7. [Sc√©narios de Test Complets](#7-sc√©narios-de-test-complets)

---

## **1. Pr√©paration de l'Environnement**

### **üöÄ D√©marrage des Services**

```bash
# Dans le r√©pertoire racine du projet
./start-all.sh
```

V√©rifiez que les services sont actifs :
- **Frontend** : http://localhost:5173
- **Backend** : http://localhost:8000
- **API Health** : http://localhost:8000/api/health

### **üìä V√©rification des Donn√©es de Base**

```bash
cd hr-backend

# V√©rifier les r√®gles de cong√©s
curl -s "http://localhost:8000/api/leave-rules" | jq '.data | length'
# Devrait retourner : 7

# V√©rifier les p√©riodes de r√©f√©rence
curl -s "http://localhost:8000/api/leave-periods" | jq '.data | length'
# Devrait retourner : 3

# V√©rifier les employ√©s
curl -s "http://localhost:8000/api/employees" | jq '.data | length'
# Devrait retourner : 13+
```

---

## **2. Test des Soldes de Cong√©s**

### **üßÆ Calcul Automatique des Soldes**

#### **Test 1 : Employ√© avec 5+ ans d'anciennet√©**

```bash
# Cr√©er un employ√© test avec anciennet√©
curl -X POST "http://localhost:8000/api/employees" \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "Marie",
    "last_name": "Martin",
    "email": "marie.martin@namie.test",
    "hire_date": "2018-01-15",
    "position": "Manager",
    "department": "RH",
    "salary": 55000,
    "phone": "0123456789"
  }' | jq '.data.id'

# Noter l'ID retourn√© (ex: 14)
EMPLOYEE_ID=14

# Calculer les soldes pour cet employ√©
curl -X POST "http://localhost:8000/api/leave-balances" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $EMPLOYEE_ID,
    \"year\": 2025
  }" | jq '.data'
```

**‚úÖ R√©sultat Attendu :**
- **Cong√©s pay√©s** : 27.5 jours (25 + 2.5 bonus anciennet√©)
- **RTT** : 12 jours (5+ ans d'anciennet√©)

#### **Test 2 : Consultation des Soldes**

```bash
# Consulter les soldes calcul√©s
curl -s "http://localhost:8000/api/leave-balances?employee_id=$EMPLOYEE_ID&year=2025" | jq '.data'
```

---

## **3. Test des R√®gles de Validation**

### **üîç Validation des Demandes de Cong√©s**

#### **Test 3 : Demande Valide (Pr√©avis OK)**

```bash
# Demande avec pr√©avis suffisant (20 jours)
curl -X POST "http://localhost:8000/api/leaves/validate-request" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $EMPLOYEE_ID,
    \"type\": \"annual\",
    \"start_date\": \"$(date -d '+20 days' +%Y-%m-%d)\",
    \"end_date\": \"$(date -d '+24 days' +%Y-%m-%d)\",
    \"days_requested\": 5
  }" | jq '.'
```

**‚úÖ R√©sultat Attendu :**
```json
{
  "success": true,
  "data": {
    "valid": true,
    "errors": [],
    "warnings": [],
    "requires_hr_approval": false
  }
}
```

#### **Test 4 : Demande Invalide (Pr√©avis Insuffisant)**

```bash
# Demande avec pr√©avis insuffisant (5 jours pour 15 jours de cong√©s)
curl -X POST "http://localhost:8000/api/leaves/validate-request" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $EMPLOYEE_ID,
    \"type\": \"annual\",
    \"start_date\": \"$(date -d '+5 days' +%Y-%m-%d)\",
    \"end_date\": \"$(date -d '+19 days' +%Y-%m-%d)\",
    \"days_requested\": 15
  }" | jq '.'
```

**‚úÖ R√©sultat Attendu :**
```json
{
  "success": true,
  "data": {
    "valid": false,
    "errors": ["Pr√©avis de 1 mois requis pour les cong√©s de plus de 5 jours"],
    "warnings": [],
    "requires_hr_approval": false
  }
}
```

#### **Test 5 : Demande N√©cessitant Approbation RH**

```bash
# Demande de plus de 10 jours cons√©cutifs
curl -X POST "http://localhost:8000/api/leaves/validate-request" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $EMPLOYEE_ID,
    \"type\": \"annual\",
    \"start_date\": \"$(date -d '+35 days' +%Y-%m-%d)\",
    \"end_date\": \"$(date -d '+49 days' +%Y-%m-%d)\",
    \"days_requested\": 15
  }" | jq '.'
```

**‚úÖ R√©sultat Attendu :**
```json
{
  "data": {
    "requires_hr_approval": true
  }
}
```

---

## **4. Test du Workflow d'Approbation**

### **üìù Cr√©ation et Approbation de Demandes**

#### **Test 6 : Cr√©er une Demande de Cong√©**

```bash
# Cr√©er une demande valide
curl -X POST "http://localhost:8000/api/leaves" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $EMPLOYEE_ID,
    \"type\": \"annual\",
    \"start_date\": \"$(date -d '+30 days' +%Y-%m-%d)\",
    \"end_date\": \"$(date -d '+34 days' +%Y-%m-%d)\",
    \"days_requested\": 5,
    \"reason\": \"Cong√©s d'√©t√©\"
  }" | jq '.data.id'

# Noter l'ID de la demande
LEAVE_ID=5
```

#### **Test 7 : Consulter la Demande**

```bash
curl -s "http://localhost:8000/api/leaves/$LEAVE_ID" | jq '.data | {id, status, approval_level, requires_hr_approval, working_days}'
```

#### **Test 8 : Workflow d'Approbation Manager**

```bash
# Simuler l'approbation par un manager
curl -X POST "http://localhost:8000/api/leaves/$LEAVE_ID/process-approval" \
  -H "Content-Type: application/json" \
  -d '{
    "decision": "approve",
    "comments": "Cong√©s approuv√©s par le manager"
  }' | jq '.data | {status, approval_level}'
```

---

## **5. Test de Gestion des Absences**

### **‚ö†Ô∏è D√©claration et Validation d'Absences**

#### **Test 9 : D√©clarer une Absence Justifi√©e**

```bash
# Absence d√©clar√©e dans les temps
curl -X POST "http://localhost:8000/api/absences" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $EMPLOYEE_ID,
    \"start_date\": \"$(date -d 'yesterday' +%Y-%m-%d)\",
    \"end_date\": \"$(date -d 'yesterday' +%Y-%m-%d)\",
    \"reason\": \"Maladie\",
    \"is_sick\": true
  }" | jq '.data.id'

ABSENCE_ID=1
```

#### **Test 10 : Consulter l'Absence**

```bash
curl -s "http://localhost:8000/api/absences/$ABSENCE_ID" | jq '.data | {absence_type, declared_on_time, medical_certificate_required, requires_action}'
```

#### **Test 11 : Absences N√©cessitant Attention**

```bash
curl -s "http://localhost:8000/api/absences/requires-attention" | jq '.count'
```

---

## **6. Test des APIs via Interface**

### **üñ•Ô∏è Tests dans le Navigateur**

1. **Acc√©dez √† l'application** : http://localhost:5173

2. **Page Employ√©s** :
   - V√©rifiez la liste des employ√©s
   - Consultez les d√©tails d'un employ√©
   - V√©rifiez les soldes de cong√©s affich√©s

3. **Page Cong√©s** :
   - Cr√©ez une nouvelle demande
   - V√©rifiez les validations en temps r√©el
   - Testez les diff√©rents types de cong√©s

4. **Page Absences** :
   - D√©clarez une absence
   - Uploadez un justificatif (si impl√©ment√©)
   - Consultez l'historique

---

## **7. Sc√©narios de Test Complets**

### **üéØ Sc√©nario A : Employ√© Exp√©riment√©**

```bash
# 1. Cr√©er employ√© senior (8 ans d'anciennet√©)
curl -X POST "http://localhost:8000/api/employees" \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "Pierre",
    "last_name": "Durand",
    "email": "pierre.durand@namie.test",
    "hire_date": "2016-03-01",
    "position": "Directeur",
    "department": "Direction",
    "salary": 75000
  }' | jq '.data.id'

SENIOR_ID=15

# 2. Calculer soldes (devrait avoir 27.5j + 12j RTT)
curl -X POST "http://localhost:8000/api/leave-balances" \
  -H "Content-Type: application/json" \
  -d "{\"employee_id\": $SENIOR_ID, \"year\": 2025}"

# 3. Demander 3 semaines de cong√©s (n√©cessite approbation RH)
curl -X POST "http://localhost:8000/api/leaves" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $SENIOR_ID,
    \"type\": \"annual\",
    \"start_date\": \"2025-07-15\",
    \"end_date\": \"2025-08-05\",
    \"days_requested\": 21,
    \"reason\": \"Cong√©s d'√©t√© obligatoires\"
  }"
```

### **üéØ Sc√©nario B : Nouveau Employ√©**

```bash
# 1. Cr√©er nouvel employ√© (6 mois d'anciennet√©)
curl -X POST "http://localhost:8000/api/employees" \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "Sophie",
    "last_name": "Bernard",
    "email": "sophie.bernard@namie.test",
    "hire_date": "2025-02-01",
    "position": "Stagiaire",
    "department": "IT",
    "salary": 25000
  }' | jq '.data.id'

JUNIOR_ID=16

# 2. Calculer soldes (devrait avoir 25j + 8j RTT)
curl -X POST "http://localhost:8000/api/leave-balances" \
  -H "Content-Type: application/json" \
  -d "{\"employee_id\": $JUNIOR_ID, \"year\": 2025}"

# 3. Demander RTT avec pr√©avis court (devrait √™tre accept√©)
curl -X POST "http://localhost:8000/api/leaves" \
  -H "Content-Type: application/json" \
  -d "{
    \"employee_id\": $JUNIOR_ID,
    \"type\": \"rtt\",
    \"start_date\": \"$(date -d '+10 days' +%Y-%m-%d)\",
    \"end_date\": \"$(date -d '+10 days' +%Y-%m-%d)\",
    \"days_requested\": 1,
    \"reason\": \"RTT\"
  }"
```

---

## **üìä V√©rifications Finales**

### **Statistiques Globales**

```bash
# Nombre total d'employ√©s
curl -s "http://localhost:8000/api/employees" | jq '.data | length'

# Nombre de r√®gles actives
curl -s "http://localhost:8000/api/leave-rules" | jq '.data | map(select(.is_active)) | length'

# Soldes calcul√©s
curl -s "http://localhost:8000/api/leave-balances?employee_id=1&year=2025" | jq '.data'

# Demandes en attente
curl -s "http://localhost:8000/api/leaves" | jq '.data | map(select(.status == "pending")) | length'
```

---

## **üîß D√©pannage**

### **Probl√®mes Courants**

1. **Erreur 404 sur les APIs** :
   ```bash
   php artisan route:list | grep leave
   ```

2. **Donn√©es manquantes** :
   ```bash
   php artisan db:seed --class=LeaveRuleSeeder
   php artisan db:seed --class=LeavePeriodSeeder
   ```

3. **Permissions manquantes** :
   ```bash
   php artisan tinker
   >>> User::first()->assignRole('super_admin')
   ```

---

## **‚úÖ Checklist de Validation**

- [ ] Services d√©marr√©s (Frontend + Backend)
- [ ] Donn√©es de base cr√©√©es (r√®gles + p√©riodes)
- [ ] Calcul des soldes fonctionnel
- [ ] Validation des r√®gles op√©rationnelle
- [ ] Workflow d'approbation test√©
- [ ] Gestion des absences fonctionnelle
- [ ] APIs accessibles et r√©pondent correctement
- [ ] Interface utilisateur coh√©rente avec l'API

---

**üéâ F√©licitations !** Si tous les tests passent, votre syst√®me de gestion des cong√©s Namie est **pleinement op√©rationnel** et pr√™t pour la production !
